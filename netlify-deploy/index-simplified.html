<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BuildAI Event Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    // Supabase credentials
    const SUPABASE_URL = 'https://ofqtgjzmbncmnkumybzb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mcXRnanptYm5jbW5rdW15YnpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NTMwNzYsImV4cCI6MjA3MDUyOTA3Nn0.35Aw-94WlR438UVT28qv54ppgvbgmlMgKfQ1Nj-t2F4';
    
    // Initialize Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Create icon components from SVGs
    const Phone = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>;
    const Users = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>;
    const CheckCircle = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
    const Building = () => <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>;
    const TrendingUp = () => <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>;
    const PhoneCall = () => <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>;
    const Upload = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>;
    const Download = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>;
    const FileDown = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
    const AlertCircle = () => <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
    const Loader2 = ({ className }) => <svg className={className} fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;
    const Search = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
    const Award = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>;

    // Test Supabase connection immediately
    console.log('Testing Supabase connection...');
    supabaseClient.from('companies').select('count').single().then(result => {
      console.log('Supabase test result:', result);
    }).catch(err => {
      console.error('Supabase test error:', err);
    });

    const App = () => {
      const [companies, setCompanies] = React.useState([]);
      const [contacts, setContacts] = React.useState([]);
      const [calls, setCalls] = React.useState([]);
      const [signups, setSignups] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [currentUser, setCurrentUser] = React.useState(null);
      const [activeTab, setActiveTab] = React.useState('dashboard');
      const [showCallModal, setShowCallModal] = React.useState(false);
      const [showSignupModal, setShowSignupModal] = React.useState(false);
      const [selectedCompany, setSelectedCompany] = React.useState(null);
      const [selectedContact, setSelectedContact] = React.useState(null);
      const [showUploadModal, setShowUploadModal] = React.useState(false);
      const [uploadStatus, setUploadStatus] = React.useState('');
      
      // Search and filter states
      const [searchTerm, setSearchTerm] = React.useState('');
      const [statusFilter, setStatusFilter] = React.useState('all');
      const [priorityFilter, setPriorityFilter] = React.useState('all');

      // Callers list
      const callers = [
        { id: 1, name: 'Sarah Johnson', email: 'sarah@entech.com' },
        { id: 2, name: 'Mike Chen', email: 'mike@entech.com' },
        { id: 3, name: 'Jessica Williams', email: 'jessica@entech.com' },
        { id: 4, name: 'David Brown', email: 'david@entech.com' },
        { id: 5, name: 'Emily Davis', email: 'emily@entech.com' },
        { id: 6, name: 'Robert Wilson', email: 'robert@entech.com' },
        { id: 7, name: 'Lisa Anderson', email: 'lisa@entech.com' },
        { id: 8, name: 'James Taylor', email: 'james@entech.com' },
        { id: 9, name: 'Maria Garcia', email: 'maria@entech.com' },
        { id: 10, name: 'John Martinez', email: 'john@entech.com' },
        { id: 11, name: 'Patricia Lee', email: 'patricia@entech.com' },
        { id: 12, name: 'Christopher Moore', email: 'christopher@entech.com' },
        { id: 13, name: 'Jennifer White', email: 'jennifer@entech.com' },
        { id: 14, name: 'Daniel Thompson', email: 'daniel@entech.com' },
        { id: 15, name: 'Amanda Harris', email: 'amanda@entech.com' }
      ];

      const [expandedCompanies, setExpandedCompanies] = React.useState(new Set());

      // Form states
      const [callForm, setCallForm] = React.useState({
        outcome: '',
        notes: '',
        followUpDate: ''
      });

      const [signupForm, setSignupForm] = React.useState({
        expectedAttendees: 1,
        specialRequirements: '',
        notes: ''
      });

      // Load initial data from Supabase
      React.useEffect(() => {
        console.log('App mounted, loading data...');
        loadData();
        setCurrentUser(callers[0]);
      }, []);

      const loadData = async () => {
        setLoading(true);
        setError(null);
        try {
          console.log('Loading all data...');
          await Promise.all([
            loadCompanies(),
            loadContacts(),
            loadCalls(),
            loadSignups()
          ]);
          console.log('All data loaded successfully');
        } catch (err) {
          console.error('Error loading data:', err);
          setError('Failed to load data. Please check your Supabase configuration.');
        } finally {
          setLoading(false);
        }
      };

      const loadCompanies = async () => {
        console.log('Loading companies...');
        const { data, error } = await supabaseClient
          .from('companies')
          .select('*')
          .order('name');
        
        if (error) {
          console.error('Error loading companies:', error);
          throw error;
        }
        console.log('Companies loaded:', data?.length || 0);
        setCompanies(data || []);
      };

      const loadContacts = async () => {
        const { data, error } = await supabaseClient
          .from('contacts')
          .select('*')
          .order('name');
        
        if (error) throw error;
        setContacts(data || []);
      };

      const loadCalls = async () => {
        const { data, error } = await supabaseClient
          .from('calls')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        setCalls(data || []);
      };

      const loadSignups = async () => {
        const { data, error } = await supabaseClient
          .from('signups')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        setSignups(data || []);
      };

      // Get contacts for a specific company
      const getCompanyContacts = (companyId) => {
        return contacts.filter(c => c.company_id === companyId);
      };

      // Filter companies based on search and filter criteria
      const getFilteredCompanies = () => {
        return companies.filter(company => {
          const matchesSearch = searchTerm === '' || 
            company.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            company.account_manager?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            company.sales_rep?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            getCompanyContacts(company.id).some(contact => 
              contact.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
              contact.email?.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
          const matchesStatus = statusFilter === 'all' || company.status === statusFilter;
          const matchesPriority = priorityFilter === 'all' || company.priority === priorityFilter;
          
          return matchesSearch && matchesStatus && matchesPriority;
        });
      };

      // Clear all filters
      const clearFilters = () => {
        setSearchTerm('');
        setStatusFilter('all');
        setPriorityFilter('all');
      };

      // Calculate metrics
      const getMetrics = () => {
        const totalCompanies = companies.length;
        const assignedCompanies = companies.filter(c => c.assigned_to).length;
        const totalCalls = calls.length;
        const totalSignups = signups.length;
        const successRate = totalCalls > 0 ? ((totalSignups / totalCalls) * 100).toFixed(1) : 0;
        
        const callerStats = callers.map(caller => {
          const callerCompanies = companies.filter(c => c.assigned_to === caller.name);
          const callerCalls = calls.filter(c => c.caller_name === caller.name);
          const callerSignups = signups.filter(s => s.caller_name === caller.name);
          
          return {
            ...caller,
            companies: callerCompanies.length,
            calls: callerCalls.length,
            signups: callerSignups.length,
            successRate: callerCalls.length > 0 ? ((callerSignups.length / callerCalls.length) * 100).toFixed(1) : 0
          };
        });

        return {
          totalCompanies,
          assignedCompanies,
          totalCalls,
          totalSignups,
          successRate,
          callerStats
        };
      };

      const metrics = getMetrics();

      // Show loading state
      if (loading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <Loader2 className="w-10 h-10 text-blue-500 animate-spin mx-auto mb-4" />
              <p className="text-gray-600">Loading BuildAI Tracker...</p>
            </div>
          </div>
        );
      }

      // Show error state
      if (error) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center max-w-md">
              <AlertCircle />
              <h2 className="text-xl font-semibold text-gray-900 mb-2">Connection Error</h2>
              <p className="text-gray-600 mb-4">{error}</p>
              <p className="text-sm text-gray-500 mb-4">
                Make sure you've created the database tables in Supabase by running the SQL setup script.
              </p>
              <button 
                onClick={loadData}
                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
              >
                Retry
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Header */}
          <div className="bg-white shadow-sm border-b">
            <div className="px-6 py-4">
              <div className="flex justify-between items-center">
                <div className="flex items-center space-x-4">
                  <h1 className="text-2xl font-bold text-gray-900">BuildAI Event Tracker</h1>
                  <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                    September 10th
                  </span>
                </div>
                <div className="flex items-center space-x-4">
                  <select 
                    value={currentUser?.id || ''} 
                    onChange={(e) => setCurrentUser(callers.find(c => c.id === parseInt(e.target.value)))}
                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    {callers.map(caller => (
                      <option key={caller.id} value={caller.id}>{caller.name}</option>
                    ))}
                  </select>
                </div>
              </div>
            </div>
          </div>

          {/* Navigation Tabs */}
          <div className="bg-white border-b">
            <div className="px-6">
              <nav className="flex space-x-8">
                {['dashboard', 'companies'].map(tab => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`py-3 px-1 border-b-2 font-medium text-sm transition-colors ${
                      activeTab === tab 
                        ? 'border-blue-500 text-blue-600' 
                        : 'border-transparent text-gray-500 hover:text-gray-700'
                    }`}
                  >
                    {tab.charAt(0).toUpperCase() + tab.slice(1)}
                  </button>
                ))}
              </nav>
            </div>
          </div>

          {/* Main Content */}
          <div className="px-6 py-6">
            {/* Dashboard Tab */}
            {activeTab === 'dashboard' && (
              <div className="space-y-6">
                {/* Metrics Cards */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-600">Total Companies</p>
                        <p className="text-2xl font-bold text-gray-900">{metrics.totalCompanies}</p>
                        <p className="text-sm text-gray-500">{metrics.assignedCompanies} assigned</p>
                      </div>
                      <Building />
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-600">Total Calls</p>
                        <p className="text-2xl font-bold text-gray-900">{metrics.totalCalls}</p>
                        <p className="text-sm text-gray-500">All callers</p>
                      </div>
                      <PhoneCall />
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-600">Signups</p>
                        <p className="text-2xl font-bold text-gray-900">{metrics.totalSignups}</p>
                        <p className="text-sm text-gray-500">
                          {signups.reduce((acc, s) => acc + (s.expected_attendees || 0), 0)} attendees
                        </p>
                      </div>
                      <CheckCircle />
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-600">Success Rate</p>
                        <p className="text-2xl font-bold text-gray-900">{metrics.successRate}%</p>
                        <p className="text-sm text-gray-500">Overall</p>
                      </div>
                      <TrendingUp />
                    </div>
                  </div>
                </div>

                {/* Instructions */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <h3 className="font-semibold text-blue-900 mb-2">Quick Start Guide:</h3>
                  <ol className="text-sm text-blue-800 space-y-1">
                    <li>1. Select your name from the dropdown in the header</li>
                    <li>2. Go to the Companies tab to see all companies</li>
                    <li>3. Click "Claim" to assign a company to yourself</li>
                    <li>4. Log calls and signups as you contact companies</li>
                  </ol>
                </div>
              </div>
            )}

            {/* Companies Tab */}
            {activeTab === 'companies' && (
              <div className="space-y-4">
                {/* Search and Filter Bar */}
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="flex flex-wrap gap-4">
                    <div className="flex-1 min-w-[300px]">
                      <div className="relative">
                        <Search />
                        <input
                          type="text"
                          placeholder="Search companies, contacts, emails..."
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                          className="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                    </div>
                    <button
                      onClick={clearFilters}
                      className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                    >
                      Clear Filters
                    </button>
                  </div>
                </div>

                {/* Companies List */}
                <div className="bg-white rounded-lg shadow">
                  <div className="px-6 py-4 border-b">
                    <h2 className="text-lg font-semibold text-gray-900">
                      Companies ({getFilteredCompanies().length})
                    </h2>
                  </div>
                  <div className="p-6">
                    {getFilteredCompanies().length === 0 ? (
                      <p className="text-gray-500 text-center py-8">
                        No companies found. Try adjusting your search filters.
                      </p>
                    ) : (
                      <div className="space-y-4">
                        {getFilteredCompanies().map(company => (
                          <div key={company.id} className="border rounded-lg p-4">
                            <div className="flex justify-between items-start">
                              <div>
                                <h3 className="font-medium text-gray-900">{company.name}</h3>
                                <p className="text-sm text-gray-500">
                                  {getCompanyContacts(company.id).length} contacts • 
                                  {company.num_buildings || 0} buildings
                                </p>
                              </div>
                              <div className="flex items-center space-x-2">
                                <span className={`px-2 py-1 text-xs rounded-full ${
                                  company.status === 'signed_up' ? 'bg-green-100 text-green-800' :
                                  company.status === 'in_progress' ? 'bg-yellow-100 text-yellow-800' :
                                  company.status === 'not_interested' ? 'bg-red-100 text-red-800' :
                                  'bg-gray-100 text-gray-800'
                                }`}>
                                  {company.status?.replace('_', ' ') || 'not started'}
                                </span>
                                {!company.assigned_to && (
                                  <button
                                    className="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                                  >
                                    Claim
                                  </button>
                                )}
                              </div>
                            </div>
                            {company.assigned_to && (
                              <p className="text-sm text-gray-600 mt-2">
                                Assigned to: {company.assigned_to}
                              </p>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Mount the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>